<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel de Controle</title>
  <script type="module">
    import {
      db, ref, push, update, remove, onValue,
      storage, sRef, uploadBytes, getDownloadURL, deleteObject
    } from './firebase.js';

    const $ = (id) => document.getElementById(id);

    // EVENTOS
    $('btnAddEvento').onclick = () => {
      const dia = $('eventoData').value.trim();
      const texto = $('eventoTexto').value.trim();
      if (dia && texto) {
        push(ref(db, 'eventos'), { dia, texto });
        $('eventoData').value = '';
        $('eventoTexto').value = '';
      }
    };

    onValue(ref(db, 'eventos'), snap => {
      const el = $('listaEventos');
      el.innerHTML = '';
      snap.forEach(child => {
        const { dia, texto } = child.val();
        el.innerHTML += `
          <div class="card">
            <b>${dia}</b><br>${texto}
            <div class="actions">
              <button onclick="editarEvento('${child.key}', '${dia}', \`${texto}\`)">‚úèÔ∏è</button>
              <button onclick="removerItem('eventos', '${child.key}')">üóëÔ∏è</button>
            </div>
          </div>`;
      });
    });

    window.editarEvento = (key, dia, texto) => {
      const novoDia = prompt('Nova data:', dia);
      const novoTexto = prompt('Novo texto:', texto);
      if (novoDia && novoTexto) {
        update(ref(db, `eventos/${key}`), { dia: novoDia, texto: novoTexto });
      }
    };

    // TAREFAS
    $('btnAddTarefa').onclick = () => {
      const texto = $('tarefaTexto').value.trim();
      if (texto) {
        push(ref(db, 'tarefas'), { texto, concluida: false });
        $('tarefaTexto').value = '';
      }
    };

    onValue(ref(db, 'tarefas'), snap => {
      const el = $('listaTarefas');
      el.innerHTML = '';
      snap.forEach(child => {
        const { texto, concluida } = child.val();
        el.innerHTML += `
          <div class="card">
            ${concluida ? `<s>${texto}</s>` : texto}
            <div class="actions">
              <button onclick="toggleConclusao('${child.key}', ${!concluida})">
                ${concluida ? '‚Ü©Ô∏è' : '‚úÖ'}
              </button>
              <button onclick="removerItem('tarefas', '${child.key}')">üóëÔ∏è</button>
            </div>
          </div>`;
      });
    });

    window.toggleConclusao = (key, status) =>
      update(ref(db, `tarefas/${key}`), { concluida: status });

    // FOTOS
    $('btnUploadFoto').onclick = () => {
      const files = $('fotoInput').files;
      Array.from(files).forEach(file => {
        const path = 'fotos/' + Date.now() + '-' + file.name;
        const fileRef = sRef(storage, path);
        uploadBytes(fileRef, file).then(() => {
          getDownloadURL(fileRef).then(url => {
            push(ref(db, 'fotos'), { url, path }); // <- SALVA NO DB
          });
        });
      });
    };

    onValue(ref(db, 'fotos'), snap => {
      const galeria = $('listaFotos');
      galeria.innerHTML = '';
      snap.forEach(child => {
        const { url, path } = child.val();
        galeria.innerHTML += `
          <div class="foto-box">
            <img src="${url}" />
            <button onclick="removerFoto('${child.key}', '${path}')">üóëÔ∏è</button>
          </div>`;
      });
    });

    // GLOBAIS
    window.removerItem = (colecao, key) =>
      remove(ref(db, `${colecao}/${key}`));

    window.removerFoto = (key, path) => {
      remove(ref(db, `fotos/${key}`));
      deleteObject(sRef(storage, path));
    };
  </script>

  <style>
    body {
      background: #111; color: #fff; font-family: sans-serif;
      padding: 20px; max-width: 1000px; margin: auto;
    }
    input, textarea, button {
      padding: 10px; margin: 5px 0; border: none;
      border-radius: 5px; width: 100%; font-size: 1rem;
    }
    button { cursor: pointer; }
    h2 { margin-top: 40px; }
    .grid { display: grid; gap: 10px; }

    .card {
      background: #222; padding: 10px; border-radius: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .actions button {
      margin-left: 5px;
      background: #444; color: white;
      border-radius: 5px; padding: 5px 10px;
    }
    .foto-box {
      position: relative; margin-top: 10px;
    }
    .foto-box img {
      width: 100%; max-height: 180px;
      object-fit: cover; border-radius: 8px;
    }
    .foto-box button {
      position: absolute; top: 10px; right: 10px;
      background: rgba(255, 0, 0, 0.7); border: none;
      padding: 6px; border-radius: 5px; color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Painel de Controle</h1>

  <h2>Eventos</h2>
  <input id="eventoData" placeholder="Data (DD/MM/AAAA)">
  <textarea id="eventoTexto" placeholder="Descri√ß√£o do evento"></textarea>
  <button id="btnAddEvento">Salvar Evento</button>
  <div id="listaEventos" class="grid"></div>

  <h2>Tarefas</h2>
  <input id="tarefaTexto" placeholder="Tarefa">
  <button id="btnAddTarefa">Salvar Tarefa</button>
  <div id="listaTarefas" class="grid"></div>

  <h2>Fotos</h2>
  <input type="file" id="fotoInput" multiple accept="image/*">
  <button id="btnUploadFoto">Enviar Fotos</button>
  <div id="listaFotos" class="grid"></div>
</body>
</html>
